"""
Mission 1: Operation Broken Gate — Web Penetration Testing

Story: You've been hired by NovaTech to pentest their internal project
management app, ProjectHub. Find SQL injection, XSS, and auth bypass
vulnerabilities before an external attacker does.

Stages:
  1. Reconnaissance — discover the target and map the surface
  2. SQL Injection — exploit a login form
  3. Cross-Site Scripting — find and demonstrate stored XSS
  4. Auth Bypass — escalate privileges to admin
  5. Debrief — report your findings
"""

from utils.display import (
    clear_screen, narrator, terminal_prompt, mission_briefing,
    mission_complete, code_block, info, sub_header, press_enter,
    C, G, Y, R, DIM, BRIGHT, RESET,
)
from utils.progress import mark_mission_complete
from missions.story_engine import (
    command_task, code_task, puzzle_task, choice_task, quiz_task, stage_intro,
)

MISSION_KEY = "mission1"
MAX_SCORE = 100


def run(progress: dict):
    """Entry point for Mission 1."""
    mission_briefing(
        mission_num=1,
        title="Operation Broken Gate",
        client="NovaTech Industries",
        objective="Penetration test the ProjectHub web application",
    )

    score = 0
    score += stage_1_recon()
    score += stage_2_sqli()
    score += stage_3_xss()
    score += stage_4_auth_bypass()
    score += stage_5_debrief()

    # Cap at max
    score = min(score, MAX_SCORE)

    mission_complete(1, "Operation Broken Gate", score, MAX_SCORE)

    # Save progress
    mark_mission_complete(progress, MISSION_KEY, score, MAX_SCORE)


# ---------------------------------------------------------------------------
# Stage 1 — Reconnaissance
# ---------------------------------------------------------------------------

def stage_1_recon() -> int:
    stage_intro(1, "RECONNAISSANCE")
    score = 0

    narrator(
        "You arrive at the NovaTech office on a rainy Monday morning. "
        "Sarah Chen, the CISO, meets you in the lobby. 'Thanks for coming,' "
        "she says, sliding a manila envelope across the table. 'ProjectHub "
        "is our internal project management tool — 200+ employees use it "
        "daily. We need to know if it's secure before we open it to clients.'"
    )
    press_enter()

    narrator(
        "Back at your laptop, you open a terminal. The target is running "
        "at projecthub.novatech.local (10.0.1.50). Time to map the attack "
        "surface. Your first move: run an nmap scan to discover open ports "
        "and services."
    )

    score += command_task(
        prompt_text="Run an nmap service version scan against the target.",
        accepted=[
            r"nmap\s+-sV\s+10\.0\.1\.50",
            r"nmap\s+-sV\s+projecthub\.novatech\.local",
            r"nmap\s+-sV\s+-p-?\s*\d*\s*10\.0\.1\.50",
            r"nmap\s+.*-sV.*10\.0\.1\.50",
        ],
        points=10,
        hints=[
            "Use the -sV flag to detect service versions",
            "nmap -sV <target_ip>",
        ],
    )

    narrator(
        "The scan results come back:\n\n"
        "  PORT    STATE  SERVICE   VERSION\n"
        "  22/tcp  open   ssh       OpenSSH 8.9\n"
        "  80/tcp  open   http      nginx 1.18\n"
        "  443/tcp open   https     nginx 1.18\n"
        "  3306/tcp open  mysql     MySQL 5.7.38\n\n"
        "Interesting — port 3306 (MySQL) is exposed to the network. That's "
        "a finding already. But first, let's check what HTTP headers reveal."
    )

    score += command_task(
        prompt_text="Use curl to fetch just the HTTP headers from the target.",
        accepted=[
            r"curl\s+-I\s+https?://10\.0\.1\.50.*",
            r"curl\s+-I\s+https?://projecthub\.novatech\.local.*",
            r"curl\s+--head\s+https?://10\.0\.1\.50.*",
        ],
        points=10,
        hints=[
            "The -I flag fetches headers only",
            "curl -I http://10.0.1.50",
        ],
    )

    narrator(
        "The headers reveal:\n\n"
        "  Server: nginx/1.18\n"
        "  X-Powered-By: PHP/7.4.3\n"
        "  Set-Cookie: PHPSESSID=abc123; path=/\n\n"
        "No security headers like X-Frame-Options, CSP, or HSTS. The "
        "cookie has no HttpOnly or Secure flags. You note these in your "
        "report — every detail matters."
    )
    press_enter()

    return score


# ---------------------------------------------------------------------------
# Stage 2 — SQL Injection
# ---------------------------------------------------------------------------

def stage_2_sqli() -> int:
    stage_intro(2, "SQL INJECTION")
    score = 0

    narrator(
        "You browse to the ProjectHub login page. A simple form: "
        "username and password fields, a 'Login' button. Your instincts "
        "tell you to test for SQL injection. The login form might be "
        "passing user input directly into a SQL query."
    )
    press_enter()

    narrator(
        "You inspect the login form. The POST request sends:\n\n"
        "  username=admin&password=test123\n\n"
        "If the backend query looks like:\n"
        "  SELECT * FROM users WHERE username='$user' AND password='$pass'\n\n"
        "...then a classic SQLi payload could bypass authentication entirely."
    )

    score += puzzle_task(
        prompt_text=(
            "What SQL injection payload would you enter in the username field "
            "to bypass the login? (The goal is to make the WHERE clause always true.)"
        ),
        accepted=[
            r".*'.*OR.*'?1'?\s*=\s*'?1.*",
            r"admin'?\s*--.*",
            r".*'\s*OR\s+1\s*=\s*1\s*--.*",
            r".*'\s*OR\s+'.*'\s*=\s*'.*",
        ],
        points=15,
        hints=[
            "Think about closing the quote and adding an OR condition",
            "Try: ' OR '1'='1' --",
        ],
    )

    narrator(
        "The login page flashes green — 'Welcome, admin!' You're in. "
        "The application blindly trusted user input in its SQL query. "
        "This is a critical vulnerability."
    )

    score += quiz_task(
        question=(
            "Which defense would BEST prevent this SQL injection attack?"
        ),
        options=[
            "Input length validation (max 20 chars)",
            "Parameterized queries / prepared statements",
            "Encoding special characters in the response",
            "Using POST instead of GET requests",
        ],
        correct_index=1,
        explanation=(
            "Parameterized queries separate SQL logic from data, making "
            "injection impossible regardless of input content."
        ),
        points=10,
    )

    return score


# ---------------------------------------------------------------------------
# Stage 3 — Cross-Site Scripting (XSS)
# ---------------------------------------------------------------------------

def stage_3_xss() -> int:
    stage_intro(3, "CROSS-SITE SCRIPTING")
    score = 0

    narrator(
        "Now that you're logged into ProjectHub as admin, you explore "
        "the application. There's a 'Project Comments' feature where "
        "team members can post updates. The comments are displayed to "
        "all project members."
    )
    press_enter()

    narrator(
        "You notice that comments are rendered as raw HTML — no "
        "sanitization, no encoding. Time to test for stored XSS. "
        "If you can inject JavaScript that executes when other users "
        "view the page, you've found a stored XSS vulnerability."
    )

    score += puzzle_task(
        prompt_text=(
            "Write a simple XSS payload to inject into the comment field "
            "that would display an alert box. What would you type?"
        ),
        accepted=[
            r"<script>alert\(.*\)[;</ ]*</script>",
            r"<script>alert\(.*\).*",
            r"<img\s+.*onerror\s*=.*alert.*",
        ],
        points=15,
        hints=[
            "The classic XSS test uses <script> tags",
            "<script>alert('XSS')</script>",
        ],
    )

    narrator(
        "You submit the comment and refresh the page. A JavaScript alert "
        "pops up — the payload executed. Every user who views this project "
        "page will run your script. In a real attack, this could steal "
        "session cookies, redirect users, or deface the page."
    )

    score += quiz_task(
        question=(
            "What is the difference between stored XSS and reflected XSS?"
        ),
        options=[
            "Stored XSS persists in the database; reflected XSS is in the URL",
            "Stored XSS uses POST; reflected XSS uses GET",
            "Stored XSS affects admins only; reflected XSS affects everyone",
            "There is no difference — they are the same attack",
        ],
        correct_index=0,
        explanation=(
            "Stored XSS is saved server-side (database) and shown to all users. "
            "Reflected XSS is embedded in a URL and only triggers when clicked."
        ),
        points=10,
    )

    return score


# ---------------------------------------------------------------------------
# Stage 4 — Authentication Bypass / Privilege Escalation
# ---------------------------------------------------------------------------

def stage_4_auth_bypass() -> int:
    stage_intro(4, "AUTHENTICATION BYPASS")
    score = 0

    narrator(
        "While exploring the admin panel, you notice that user roles "
        "are controlled by a cookie value:\n\n"
        "  Cookie: role=user; session=abc123def456\n\n"
        "That's suspicious. Could it really be that simple? You decide "
        "to test whether changing the cookie value grants elevated access."
    )

    score += choice_task(
        prompt_text=(
            "How do you approach testing this cookie-based access control?"
        ),
        options=[
            ("Modify the cookie", "Change role=user to role=admin in your browser dev tools and refresh", 20),
            ("Brute-force admin password", "Try common passwords against the admin account", 5),
            ("Check robots.txt for admin paths", "Look for hidden admin endpoints", 10),
        ],
    )

    narrator(
        "You open the browser dev tools, navigate to the cookie storage, "
        "and change 'role=user' to 'role=admin'. You refresh the page — "
        "and suddenly you see the full admin panel: user management, "
        "database backups, system configuration. The application trusts "
        "a client-side cookie for authorization. Critical finding."
    )
    press_enter()

    return score


# ---------------------------------------------------------------------------
# Stage 5 — Debrief
# ---------------------------------------------------------------------------

def stage_5_debrief() -> int:
    stage_intro(5, "MISSION DEBRIEF")
    score = 0

    narrator(
        "You sit down with Sarah Chen to present your findings. She "
        "leans forward as you walk through each vulnerability. 'We need "
        "to fix these before we open ProjectHub to clients,' she says. "
        "'What are your top recommendations?'"
    )

    score += quiz_task(
        question=(
            "You need to prioritize remediation. Which vulnerability "
            "should NovaTech fix FIRST?"
        ),
        options=[
            "Missing security headers (X-Frame-Options, CSP)",
            "SQL injection on the login form",
            "Stored XSS in comments",
            "Exposed MySQL port (3306)",
        ],
        correct_index=1,
        explanation=(
            "SQL injection on the login form allows complete authentication "
            "bypass and potential database access — it's the highest severity."
        ),
        points=10,
    )

    narrator(
        "Sarah nods. 'We'll get the dev team on parameterized queries "
        "immediately. What about the cookie issue?'\n\n"
        "You explain that authorization decisions must NEVER rely on "
        "client-side data. Server-side session management with proper "
        "role checks is the way to go.\n\n"
        "'Great work,' Sarah says, shaking your hand. 'You may have just "
        "saved us from a very bad day.'"
    )
    press_enter()

    return score
